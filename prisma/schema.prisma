// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id        String   @id @default(uuid())
  libelle   String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users User[]
}

model User {
  id        String  @id @default(uuid())
  nom       String
  prenom    String?
  telephone String?
  email     String  @unique
  password  String
  titre     String? // Titre/spécialité (ex: "Conseiller juridique", "Conseiller en sécurité")

  roleId String
  role   Role   @relation(fields: [roleId], references: [id])

  notifications     Notification[]
  courriersCreated  Courrier[]        @relation("Creator")
  courriersDestines Courrier[]        @relation("Destinataire")
  reponses          ReponseCourrier[] @relation("Responder")
  annotations       Annotation[]      @relation("Annotateur")
  courriersLu       CourrierLu[]
  archives          ArchiveCourrier[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TypeCourrier {
  id        String   @id @default(uuid())
  libelle   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courriers Courrier[]
}

model CourrierLu {
  id         String   @id @default(uuid())
  courrierId String
  courrier   Courrier @relation(fields: [courrierId], references: [id])

  userId String
  user   User   @relation(fields: [userId], references: [id])

  lu        Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courrierId, userId]) // Chaque utilisateur ne peut avoir qu'une entrée par courrier
}

model Origine {
  id        String   @id @default(uuid())
  libelle   String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courriers Courrier[]
}

model Courrier {
  id              String    @id @default(uuid())
  numero_courrier String    @unique
  objet           String
  description     String?
  date_signature  DateTime?
  fichier_joint   String?
  s3_key          String?

  archive ArchiveCourrier?

  origineId String?
  origine   Origine? @relation(fields: [origineId], references: [id])

  // Type
  typeId String?
  type   TypeCourrier? @relation(fields: [typeId], references: [id])

  destUserId   String
  destinataire User   @relation("Destinataire", fields: [destUserId], references: [id])

  // Creator (receptionniste)
  creatorId String
  creator   User   @relation("Creator", fields: [creatorId], references: [id])

  statutId String?
  statut   StatutCourrier? @relation(fields: [statutId], references: [id])

  reponses      ReponseCourrier[]
  annotations   Annotation[]
  courriersLu   CourrierLu[]
  notifications Notification[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model StatutCourrier {
  id        String   @id @default(uuid())
  libelle   String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  courriers Courrier[]
}

model Annotation {
  id       String @id @default(uuid())
  contenu  String
  priorite String

  courrierId String
  courrier   Courrier @relation(fields: [courrierId], references: [id])

  auteurId String
  auteur   User   @relation("Annotateur", fields: [auteurId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ReponseCourrier {
  id             String    @id @default(uuid())
  date_signature DateTime?
  fichier_joint  String?
  objet          String?

  courrierId String
  courrier   Courrier @relation(fields: [courrierId], references: [id])

  responderId String
  responder   User   @relation("Responder", fields: [responderId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id      String @id @default(uuid())
  message String
  statut  String @default("unread")

  userId String
  user   User   @relation(fields: [userId], references: [id])

  courrierId String?
  courrier   Courrier? @relation(fields: [courrierId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ArchiveCategorie {
  TRAITE
  CLASSE_SANS_SUITE
}

model ArchiveCourrier {
  id        String           @id @default(uuid())
  categorie ArchiveCategorie
  commentaire String?

  courrierId String   @unique
  courrier   Courrier @relation(fields: [courrierId], references: [id])

  archivedById String
  archivedBy   User   @relation(fields: [archivedById], references: [id])

  createdAt DateTime @default(now())
}

